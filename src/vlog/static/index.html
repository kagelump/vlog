<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Classification Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #6366f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        /* Thumbnail hover effect */
        .thumbnail-hover {
            transition: transform 0.2s, opacity 0.2s;
        }
        .thumbnail-hover:hover {
            transform: scale(1.05);
            opacity: 0.95;
        }
        
        /* Row hover effect */
        .table-row-hover {
            transition: background-color 0.2s;
        }
        .table-row-hover:hover {
            background-color: rgba(99, 102, 241, 0.05);
        }
        
        /* Loading skeleton animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Star rating */
        .star-filled {
            color: #fbbf24;
        }
        .star-empty {
            color: #d1d5db;
        }
        
        /* Sort indicator */
        .sort-indicator {
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 0.25rem;
            vertical-align: middle;
        }
        .sort-asc {
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid currentColor;
        }
        .sort-desc {
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid currentColor;
        }
        
        /* Modal backdrop */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-indigo-700">Video Classification Dashboard</h1>
                    <p class="text-sm text-gray-600 mt-1">View-only interface for classified video clips</p>
                </div>
                <a href="/" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                    ‚Üê Back to Launcher
                </a>
            </div>
        </div>
    </header>

    <!-- Statistics Bar -->
    <div class="bg-indigo-50 border-b border-indigo-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-indigo-700" id="stat-total">0</div>
                    <div class="text-xs text-gray-600">Total Videos</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="stat-keep">0</div>
                    <div class="text-xs text-gray-600">Keep</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600" id="stat-discard">0</div>
                    <div class="text-xs text-gray-600">Discard</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-indigo-600" id="stat-duration">0:00</div>
                    <div class="text-xs text-gray-600">Total Duration</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-amber-600" id="stat-rating">0.0</div>
                    <div class="text-xs text-gray-600">Avg Rating</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold text-gray-700" id="stat-showing">0/0</div>
                    <div class="text-xs text-gray-600">Showing</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Controls -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-wrap gap-4 items-center">
                <!-- Search -->
                <div class="flex-1 min-w-[200px]">
                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="Search descriptions..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                    />
                </div>
                
                <!-- Keep Status Filter -->
                <div class="flex gap-1 bg-gray-100 rounded-lg p-1">
                    <button 
                        data-filter="all" 
                        class="keep-filter-btn px-3 py-1 rounded text-sm font-medium transition-colors bg-indigo-600 text-white"
                    >
                        All
                    </button>
                    <button 
                        data-filter="keep" 
                        class="keep-filter-btn px-3 py-1 rounded text-sm font-medium transition-colors text-gray-700 hover:bg-gray-200"
                    >
                        Keep
                    </button>
                    <button 
                        data-filter="discard" 
                        class="keep-filter-btn px-3 py-1 rounded text-sm font-medium transition-colors text-gray-700 hover:bg-gray-200"
                    >
                        Discard
                    </button>
                </div>
                
                <!-- Auto-refresh -->
                <div class="flex items-center gap-2">
                    <select 
                        id="refresh-interval"
                        class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500"
                    >
                        <option value="30">Refresh: 30s</option>
                        <option value="60" selected>Refresh: 60s</option>
                        <option value="120">Refresh: 2min</option>
                        <option value="0">Manual only</option>
                    </select>
                    <button 
                        id="pause-refresh-btn"
                        class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition-colors"
                        title="Pause auto-refresh"
                    >
                        ‚è∏
                    </button>
                    <span id="refresh-status" class="text-xs text-gray-500">Next: 60s</span>
                </div>
                
                <!-- Clear Filters -->
                <button 
                    id="clear-filters-btn"
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition-colors"
                >
                    Clear Filters
                </button>
            </div>
            
            <!-- Advanced Filters Row -->
            <div class="mt-3 flex flex-wrap gap-3" id="advanced-filters">
                <!-- Clip Type Filter -->
                <div class="flex-1 min-w-[150px]">
                    <select 
                        id="clip-type-filter"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500"
                    >
                        <option value="">All Clip Types</option>
                    </select>
                </div>
                
                <!-- Rating Filter -->
                <div class="flex-1 min-w-[200px]">
                    <label class="text-xs text-gray-600 block mb-1">Min Rating: <span id="rating-value">0.0</span></label>
                    <input 
                        type="range" 
                        id="rating-filter"
                        min="0" 
                        max="1" 
                        step="0.1" 
                        value="0"
                        class="w-full"
                    />
                </div>
                
                <!-- Sort -->
                <div class="flex-1 min-w-[150px]">
                    <select 
                        id="sort-select"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500"
                    >
                        <option value="timestamp-asc">Oldest First</option>
                        <option value="timestamp-desc">Newest First</option>
                        <option value="rating-desc">Highest Rated</option>
                        <option value="rating-asc">Lowest Rated</option>
                        <option value="duration-desc">Longest First</option>
                        <option value="duration-asc">Shortest First</option>
                        <option value="filename-asc">Filename A-Z</option>
                        <option value="filename-desc">Filename Z-A</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Loading State -->
            <div id="loading-state" class="p-12 text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
                <p class="mt-4 text-gray-600">Loading classifications...</p>
            </div>
            
            <!-- Error State -->
            <div id="error-state" class="p-12 text-center hidden">
                <div class="text-red-600 text-5xl mb-4">‚ö†Ô∏è</div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Connection Error</h3>
                <p class="text-gray-600 mb-4">Could not load video classifications</p>
                <button 
                    onclick="fetchResults(true)" 
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                >
                    Retry
                </button>
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="p-12 text-center hidden">
                <div class="text-gray-400 text-5xl mb-4">üìπ</div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">No Videos Found</h3>
                <p class="text-gray-600">No classified videos match your current filters</p>
            </div>
            
            <!-- Table -->
            <div id="table-container" class="overflow-x-auto custom-scrollbar hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-28">
                                Thumbnail
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                                Filename
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                                Description
                            </th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-32">
                                Type
                            </th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-24">
                                Rating
                            </th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-24">
                                Status
                            </th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-24">
                                Duration
                            </th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-sm text-gray-600">
        <p>Last updated: <span id="last-updated" class="font-medium">Never</span></p>
        <p class="mt-1">
            Videos grouped by scene (within 30 minutes) ‚Ä¢ 
            <a href="/" class="text-indigo-600 hover:text-indigo-800">Back to Launcher</a>
        </p>
    </footer>

    <!-- Modal for Video Detail -->
    <div 
        id="video-modal" 
        class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop bg-black bg-opacity-75"
        onclick="closeModal()"
    >
        <div 
            class="bg-white rounded-lg shadow-2xl max-w-6xl w-full max-h-[95vh] overflow-y-auto"
            onclick="event.stopPropagation()"
        >
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50">
                <h3 id="modal-title" class="text-xl font-semibold text-indigo-800 truncate pr-4"></h3>
                <button 
                    onclick="closeModal()" 
                    class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-200 transition"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-4 flex flex-col md:flex-row gap-6">
                <!-- Video Player (Left - 66%) -->
                <div class="md:w-2/3 flex flex-col justify-center items-center bg-gray-100 rounded-lg p-2">
                    <video 
                        id="modal-video" 
                        controls 
                        class="max-w-full max-h-[70vh] object-contain rounded-md shadow-lg w-full"
                    ></video>
                </div>
                
                <!-- Metadata Panel (Right - 33%) -->
                <div class="md:w-1/3 space-y-4 text-sm">
                    <h4 class="text-lg font-bold text-indigo-700 border-b pb-2">Video Details</h4>
                    
                    <!-- Filename -->
                    <div>
                        <span class="text-xs text-gray-500 font-semibold">Filename:</span>
                        <p id="modal-filename" class="text-sm font-medium text-gray-800 break-all"></p>
                    </div>
                    
                    <!-- Short Description -->
                    <div id="modal-short-desc" class="text-base font-semibold text-gray-800"></div>
                    
                    <!-- Metadata Row -->
                    <div class="flex flex-wrap gap-2 items-center">
                        <div id="modal-clip-type" class="px-3 py-1 text-xs font-medium rounded-full"></div>
                        <div id="modal-rating-display" class="flex items-center gap-1"></div>
                    </div>
                    
                    <!-- Stats -->
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div>
                            <span class="text-gray-500">Timestamp:</span>
                            <p id="modal-timestamp" class="font-medium text-gray-700"></p>
                        </div>
                        <div>
                            <span class="text-gray-500">Length:</span>
                            <p id="modal-length" class="font-medium text-gray-700"></p>
                        </div>
                        <div>
                            <span class="text-gray-500">Status:</span>
                            <p id="modal-keep-status" class="font-medium"></p>
                        </div>
                        <div>
                            <span class="text-gray-500">Duration:</span>
                            <p id="modal-duration" class="font-medium text-gray-700"></p>
                        </div>
                    </div>
                    
                    <!-- In/Out Times -->
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div>
                            <span class="text-gray-500">In Time:</span>
                            <p id="modal-in-time" class="font-mono text-xs text-gray-700"></p>
                        </div>
                        <div>
                            <span class="text-gray-500">Out Time:</span>
                            <p id="modal-out-time" class="font-mono text-xs text-gray-700"></p>
                        </div>
                    </div>
                    
                    <!-- Tags -->
                    <div>
                        <span class="text-xs text-gray-500 font-semibold">Tags:</span>
                        <div id="modal-tags" class="flex flex-wrap gap-1 mt-1"></div>
                    </div>
                    
                    <!-- Scene Indicators -->
                    <div id="modal-scene-indicators" class="flex gap-2"></div>
                    
                    <!-- Long Description -->
                    <div class="pt-2 border-t">
                        <h5 class="text-sm font-semibold text-gray-600 mb-1">Full Description</h5>
                        <p id="modal-long-desc" class="text-xs text-gray-600 p-2 border rounded bg-gray-50 max-h-40 overflow-y-auto custom-scrollbar"></p>
                    </div>
                    
                    <!-- Transcript -->
                    <div id="modal-transcript-section" class="pt-2 border-t hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="text-sm font-semibold text-gray-600">Transcript</h5>
                            <button 
                                id="toggle-transcript-btn"
                                class="text-xs text-indigo-600 hover:text-indigo-800 font-medium"
                            >
                                Show
                            </button>
                        </div>
                        <div 
                            id="modal-transcript-content" 
                            class="text-xs text-gray-600 p-2 border rounded bg-gray-50 max-h-48 overflow-y-auto custom-scrollbar hidden whitespace-pre-wrap font-mono"
                        ></div>
                    </div>
                    
                    <!-- Navigation Hint -->
                    <div class="pt-2 border-t text-xs text-gray-500 text-center">
                        Use ‚Üê ‚Üí arrows to navigate ‚Ä¢ ESC to close
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONSTANTS AND CONFIGURATION =====
        const SCENE_THRESHOLD_MS = 30 * 60 * 1000; // 30 minutes
        const SCENE_COLORS = [
            'border-l-4 border-rose-500 bg-rose-50/50',
            'border-l-4 border-indigo-500 bg-indigo-50/50',
            'border-l-4 border-green-500 bg-green-50/50',
            'border-l-4 border-amber-500 bg-amber-50/50',
            'border-l-4 border-purple-500 bg-purple-50/50',
            'border-l-4 border-cyan-500 bg-cyan-50/50',
        ];
        
        const CLIP_TYPE_COLORS = {
            'pov': 'bg-blue-100 text-blue-800',
            'insert': 'bg-green-100 text-green-800',
            'establishing': 'bg-cyan-100 text-cyan-800',
            'close': 'bg-green-100 text-green-800',
            'wide': 'bg-cyan-100 text-cyan-800',
            'aerial': 'bg-purple-100 text-purple-800',
            'drone': 'bg-purple-100 text-purple-800',
            'b-roll': 'bg-yellow-100 text-yellow-800',
            'scenic': 'bg-yellow-100 text-yellow-800',
        };
        
        // ===== STATE MANAGEMENT =====
        let allResults = []; // All videos from API
        let filteredResults = []; // After applying filters
        let currentIndex = -1; // Current video in modal
        let refreshTimer = null;
        let isPaused = false;
        let nextRefreshTime = null;
        
        // Filter state
        let filters = {
            search: '',
            keepStatus: 'all',
            clipType: '',
            minRating: 0.0,
        };
        
        // Sort state
        let sortConfig = {
            field: 'timestamp',
            direction: 'asc'
        };
        
        // ===== DOM ELEMENTS =====
        const elements = {
            // States
            loadingState: document.getElementById('loading-state'),
            errorState: document.getElementById('error-state'),
            emptyState: document.getElementById('empty-state'),
            tableContainer: document.getElementById('table-container'),
            tableBody: document.getElementById('table-body'),
            
            // Statistics
            statTotal: document.getElementById('stat-total'),
            statKeep: document.getElementById('stat-keep'),
            statDiscard: document.getElementById('stat-discard'),
            statDuration: document.getElementById('stat-duration'),
            statRating: document.getElementById('stat-rating'),
            statShowing: document.getElementById('stat-showing'),
            
            // Filters
            searchInput: document.getElementById('search-input'),
            keepFilterBtns: document.querySelectorAll('.keep-filter-btn'),
            clipTypeFilter: document.getElementById('clip-type-filter'),
            ratingFilter: document.getElementById('rating-filter'),
            ratingValue: document.getElementById('rating-value'),
            clearFiltersBtn: document.getElementById('clear-filters-btn'),
            sortSelect: document.getElementById('sort-select'),
            
            // Refresh controls
            refreshInterval: document.getElementById('refresh-interval'),
            pauseRefreshBtn: document.getElementById('pause-refresh-btn'),
            refreshStatus: document.getElementById('refresh-status'),
            lastUpdated: document.getElementById('last-updated'),
            
            // Modal
            modal: document.getElementById('video-modal'),
            modalVideo: document.getElementById('modal-video'),
            modalTitle: document.getElementById('modal-title'),
            modalFilename: document.getElementById('modal-filename'),
            modalShortDesc: document.getElementById('modal-short-desc'),
            modalLongDesc: document.getElementById('modal-long-desc'),
            modalClipType: document.getElementById('modal-clip-type'),
            modalRatingDisplay: document.getElementById('modal-rating-display'),
            modalTimestamp: document.getElementById('modal-timestamp'),
            modalLength: document.getElementById('modal-length'),
            modalKeepStatus: document.getElementById('modal-keep-status'),
            modalDuration: document.getElementById('modal-duration'),
            modalInTime: document.getElementById('modal-in-time'),
            modalOutTime: document.getElementById('modal-out-time'),
            modalTags: document.getElementById('modal-tags'),
            modalSceneIndicators: document.getElementById('modal-scene-indicators'),
            modalTranscriptSection: document.getElementById('modal-transcript-section'),
            modalTranscriptContent: document.getElementById('modal-transcript-content'),
            toggleTranscriptBtn: document.getElementById('toggle-transcript-btn'),
        };
        
        // ===== UTILITY FUNCTIONS =====
        
        function formatTimestamp(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            }) + ' ' + date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }
        
        function formatTimecode(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                const [time, milliseconds] = timestamp.split('.');
                const [hours, minutes, seconds] = time.split(':').map(num => num.padStart(2, '0'));
                const ms = milliseconds ? milliseconds.padEnd(4, '0').slice(0, 4) : '0000';
                return `${hours}:${minutes}:${seconds}.${ms}`;
            } catch {
                return 'Invalid';
            }
        }
        
        function formatDuration(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds) || seconds < 0) return 'N/A';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
            return `${minutes}:${String(secs).padStart(2, '0')}`;
        }
        
        function getTimeInMs(isoString) {
            if (!isoString) return 0;
            return new Date(isoString).getTime();
        }
        
        function getClipTypeClass(clipType) {
            if (!clipType) return 'bg-gray-100 text-gray-800';
            const type = clipType.toLowerCase();
            for (const [key, colorClass] of Object.entries(CLIP_TYPE_COLORS)) {
                if (type.includes(key)) {
                    return colorClass;
                }
            }
            return 'bg-gray-100 text-gray-800';
        }
        
        function renderStars(rating) {
            if (rating == null) return '<span class="text-gray-400 text-xs">No rating</span>';
            
            const stars = [];
            const fullStars = Math.floor(rating);
            const hasHalfStar = (rating % 1) >= 0.5;
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    stars.push('<span class="star-filled">‚òÖ</span>');
                } else if (i === fullStars && hasHalfStar) {
                    stars.push('<span class="star-filled">‚òÖ</span>');
                } else {
                    stars.push('<span class="star-empty">‚òÖ</span>');
                }
            }
            
            return stars.join('') + ` <span class="text-xs text-gray-600 ml-1">${rating.toFixed(1)}</span>`;
        }
        
        // ===== DATA PROCESSING =====
        
        function processSceneClustering(results) {
            if (results.length === 0) return results;
            
            // Sort by timestamp
            const sorted = [...results].sort((a, b) => 
                getTimeInMs(a.video_timestamp) - getTimeInMs(b.video_timestamp)
            );
            
            // Assign scene IDs
            let currentSceneId = 0;
            let lastTimestampMs = 0;
            
            sorted.forEach((result, index) => {
                const currentTimestampMs = getTimeInMs(result.video_timestamp);
                const timeDiff = currentTimestampMs - lastTimestampMs;
                
                if (timeDiff > SCENE_THRESHOLD_MS || index === 0) {
                    currentSceneId++;
                    if (index > 0) {
                        sorted[index - 1].isLastInScene = true;
                    }
                    result.isFirstInScene = true;
                    result.isLastInScene = false;
                } else {
                    result.isFirstInScene = false;
                    result.isLastInScene = false;
                }
                
                result.sceneId = currentSceneId;
                lastTimestampMs = currentTimestampMs;
            });
            
            // Mark last item as end of scene
            if (sorted.length > 0) {
                sorted[sorted.length - 1].isLastInScene = true;
            }
            
            return sorted;
        }
        
        function applyFilters(results) {
            return results.filter(result => {
                // Search filter
                if (filters.search) {
                    const searchLower = filters.search.toLowerCase();
                    const shortDesc = (result.video_description_short || '').toLowerCase();
                    const longDesc = (result.video_description_long || '').toLowerCase();
                    if (!shortDesc.includes(searchLower) && !longDesc.includes(searchLower)) {
                        return false;
                    }
                }
                
                // Keep status filter
                if (filters.keepStatus !== 'all') {
                    const isKeep = result.keep === 1;
                    if (filters.keepStatus === 'keep' && !isKeep) return false;
                    if (filters.keepStatus === 'discard' && isKeep) return false;
                }
                
                // Clip type filter
                if (filters.clipType && result.primary_shot_type !== filters.clipType) {
                    return false;
                }
                
                // Rating filter
                if (result.rating != null && result.rating < filters.minRating) {
                    return false;
                }
                
                return true;
            });
        }
        
        function applySorting(results) {
            const sorted = [...results];
            
            sorted.sort((a, b) => {
                let aVal, bVal;
                
                switch (sortConfig.field) {
                    case 'timestamp':
                        aVal = getTimeInMs(a.video_timestamp);
                        bVal = getTimeInMs(b.video_timestamp);
                        break;
                    case 'rating':
                        aVal = a.rating || 0;
                        bVal = b.rating || 0;
                        break;
                    case 'duration':
                        aVal = a.video_length_seconds || 0;
                        bVal = b.video_length_seconds || 0;
                        break;
                    case 'filename':
                        aVal = (a.filename || '').toLowerCase();
                        bVal = (b.filename || '').toLowerCase();
                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    default:
                        return 0;
                }
                
                if (sortConfig.direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
            
            return sorted;
        }
        
        function calculateStatistics(results) {
            const stats = {
                total: results.length,
                keep: 0,
                discard: 0,
                totalDuration: 0,
                totalRating: 0,
                ratedCount: 0,
            };
            
            results.forEach(result => {
                if (result.keep === 1) {
                    stats.keep++;
                } else {
                    stats.discard++;
                }
                
                if (result.video_length_seconds) {
                    stats.totalDuration += result.video_length_seconds;
                }
                
                if (result.rating != null) {
                    stats.totalRating += result.rating;
                    stats.ratedCount++;
                }
            });
            
            return stats;
        }
        
        function updateStatistics() {
            const allStats = calculateStatistics(allResults);
            const filteredStats = calculateStatistics(filteredResults);
            
            elements.statTotal.textContent = allStats.total;
            elements.statKeep.textContent = allStats.keep;
            elements.statDiscard.textContent = allStats.discard;
            elements.statDuration.textContent = formatDuration(allStats.totalDuration);
            elements.statRating.textContent = allStats.ratedCount > 0 
                ? (allStats.totalRating / allStats.ratedCount).toFixed(1)
                : '0.0';
            elements.statShowing.textContent = `${filteredResults.length}/${allStats.total}`;
        }
        
        // ===== RENDERING =====
        
        function showLoading() {
            elements.loadingState.classList.remove('hidden');
            elements.errorState.classList.add('hidden');
            elements.emptyState.classList.add('hidden');
            elements.tableContainer.classList.add('hidden');
        }
        
        function showError() {
            elements.loadingState.classList.add('hidden');
            elements.errorState.classList.remove('hidden');
            elements.emptyState.classList.add('hidden');
            elements.tableContainer.classList.add('hidden');
        }
        
        function showEmpty() {
            elements.loadingState.classList.add('hidden');
            elements.errorState.classList.add('hidden');
            elements.emptyState.classList.remove('hidden');
            elements.tableContainer.classList.add('hidden');
        }
        
        function showTable() {
            elements.loadingState.classList.add('hidden');
            elements.errorState.classList.add('hidden');
            elements.emptyState.classList.add('hidden');
            elements.tableContainer.classList.remove('hidden');
        }
        
        function renderTable() {
            if (filteredResults.length === 0) {
                showEmpty();
                return;
            }
            
            showTable();
            elements.tableBody.innerHTML = '';
            
            filteredResults.forEach((result, index) => {
                // Scene break separator
                if (result.isFirstInScene && index > 0) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `
                        <td colspan="7" class="p-2 border-t-4 border-dashed border-gray-300 bg-gray-100 text-center text-xs font-semibold text-gray-500">
                            Scene Break (30+ minutes)
                        </td>
                    `;
                    elements.tableBody.appendChild(separatorRow);
                }
                
                const sceneColorClass = SCENE_COLORS[(result.sceneId - 1) % SCENE_COLORS.length];
                const clipTypeClass = getClipTypeClass(result.primary_shot_type);
                const isKeep = result.keep === 1;
                
                const row = document.createElement('tr');
                row.className = `${sceneColorClass} table-row-hover cursor-pointer`;
                row.dataset.index = index;
                
                // Determine duration display
                const originalLength = result.video_length_seconds || 0;
                const cutDuration = result.clip_cut_duration;
                let durationDisplay = 'FULL';
                if (cutDuration !== null && cutDuration > 0 && cutDuration < originalLength) {
                    durationDisplay = formatDuration(cutDuration);
                }
                
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="w-24 h-16 bg-gray-200 rounded overflow-hidden thumbnail-hover">
                            <img 
                                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E"
                                data-src="/api/thumbnail-file/${encodeURIComponent(result.filename)}"
                                alt="Thumbnail"
                                class="w-full h-full object-cover lazy-thumbnail skeleton"
                            />
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-sm text-gray-900 truncate max-w-[200px]">${result.filename}</div>
                        <div class="text-xs text-gray-500 mt-0.5">${formatTimestamp(result.video_timestamp)}</div>
                    </td>
                    <td class="px-4 py-3 max-w-md">
                        <div class="font-semibold text-sm text-gray-800 mb-1">${result.video_description_short || 'No description'}</div>
                        <div class="text-xs text-gray-600 line-clamp-2">${result.video_description_long || ''}</div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-3 py-1 inline-flex text-xs font-semibold rounded-full ${clipTypeClass}">
                            ${result.primary_shot_type || 'Unknown'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="inline-flex items-center gap-1">
                            ${renderStars(result.rating)}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-xs font-semibold rounded ${isKeep ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${isKeep ? 'KEEP' : 'DISCARD'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="text-sm ${cutDuration !== null && cutDuration < originalLength ? 'font-bold text-red-600' : 'text-gray-600'}">
                            ${durationDisplay}
                        </span>
                    </td>
                `;
                
                elements.tableBody.appendChild(row);
            });
            
            // Lazy load thumbnails
            loadVisibleThumbnails();
        }
        
        // ===== THUMBNAIL LAZY LOADING =====
        
        let thumbnailObserver = null;
        
        function loadVisibleThumbnails() {
            // Disconnect old observer
            if (thumbnailObserver) {
                thumbnailObserver.disconnect();
            }
            
            // Create new observer
            thumbnailObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const src = img.dataset.src;
                        if (src && !img.src.includes('/api/')) {
                            img.src = src;
                            img.classList.remove('skeleton');
                            thumbnailObserver.unobserve(img);
                        }
                    }
                });
            }, {
                rootMargin: '100px'
            });
            
            // Observe all lazy thumbnails
            document.querySelectorAll('.lazy-thumbnail').forEach(img => {
                thumbnailObserver.observe(img);
            });
        }
        
        // ===== MODAL =====
        
        function openModal(index) {
            if (index < 0 || index >= filteredResults.length) return;
            
            currentIndex = index;
            const result = filteredResults[index];
            
            // Set video source
            elements.modalVideo.src = `/video/${encodeURIComponent(result.filename)}`;
            elements.modalVideo.poster = `/api/thumbnail-file/${encodeURIComponent(result.filename)}`;
            
            // Set text content
            elements.modalTitle.textContent = result.video_description_short || 'No title';
            elements.modalFilename.textContent = result.filename;
            elements.modalShortDesc.textContent = result.video_description_short || 'No description';
            elements.modalLongDesc.textContent = result.video_description_long || 'No detailed description available';
            
            // Set metadata
            const clipTypeClass = getClipTypeClass(result.primary_shot_type);
            elements.modalClipType.className = `px-3 py-1 text-xs font-medium rounded-full ${clipTypeClass}`;
            elements.modalClipType.textContent = result.primary_shot_type || 'Unknown';
            
            elements.modalRatingDisplay.innerHTML = renderStars(result.rating);
            elements.modalTimestamp.textContent = formatTimestamp(result.video_timestamp);
            elements.modalLength.textContent = formatDuration(result.video_length_seconds);
            
            const isKeep = result.keep === 1;
            elements.modalKeepStatus.textContent = isKeep ? 'KEEP' : 'DISCARD';
            elements.modalKeepStatus.className = isKeep ? 'text-green-700 font-bold' : 'text-red-700 font-bold';
            
            const originalLength = result.video_length_seconds || 0;
            const cutDuration = result.clip_cut_duration;
            if (cutDuration !== null && cutDuration > 0 && cutDuration < originalLength) {
                elements.modalDuration.textContent = `${formatDuration(cutDuration)} (cut)`;
            } else {
                elements.modalDuration.textContent = 'FULL';
            }
            
            elements.modalInTime.textContent = formatTimecode(result.in_timestamp);
            elements.modalOutTime.textContent = formatTimecode(result.out_timestamp);
            
            // Tags
            const tags = Array.isArray(result.tags) ? result.tags : [];
            elements.modalTags.innerHTML = tags.length > 0 
                ? tags.map(tag => `<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">${tag}</span>`).join('')
                : '<span class="text-xs text-gray-400">No tags</span>';
            
            // Scene indicators
            elements.modalSceneIndicators.innerHTML = '';
            if (result.isFirstInScene) {
                elements.modalSceneIndicators.innerHTML += '<span class="px-2 py-1 text-xs font-bold rounded bg-rose-100 text-rose-700 border border-rose-400">START OF SCENE</span>';
            }
            if (result.isLastInScene && !result.isFirstInScene) {
                elements.modalSceneIndicators.innerHTML += '<span class="px-2 py-1 text-xs font-bold rounded bg-cyan-100 text-cyan-700 border border-cyan-400">END OF SCENE</span>';
            }
            
            // Load transcript
            loadTranscript(result.filename);
            
            // Show modal
            elements.modal.classList.remove('hidden');
            elements.modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            elements.modal.classList.remove('flex');
            elements.modal.classList.add('hidden');
            document.body.style.overflow = '';
            elements.modalVideo.pause();
            currentIndex = -1;
        }
        
        function navigateModal(direction) {
            if (currentIndex === -1) return;
            
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = filteredResults.length - 1;
            if (newIndex >= filteredResults.length) newIndex = 0;
            
            openModal(newIndex);
        }
        
        async function loadTranscript(filename) {
            try {
                const response = await fetch(`/api/subtitle/${encodeURIComponent(filename)}`);
                if (!response.ok) {
                    elements.modalTranscriptSection.classList.add('hidden');
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.subtitle) {
                    elements.modalTranscriptContent.textContent = data.subtitle;
                    elements.modalTranscriptSection.classList.remove('hidden');
                    elements.modalTranscriptContent.classList.add('hidden');
                    elements.toggleTranscriptBtn.textContent = 'Show';
                } else {
                    elements.modalTranscriptSection.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading transcript:', error);
                elements.modalTranscriptSection.classList.add('hidden');
            }
        }
        
        // ===== API =====
        
        async function fetchResults(showLoadingIndicator = false) {
            if (showLoadingIndicator) {
                showLoading();
            }
            
            try {
                const response = await fetch('/api/metadata');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                allResults = processSceneClustering(data);
                
                // Update clip type filter options
                updateClipTypeFilter();
                
                // Apply filters and render
                applyFiltersAndRender();
                
                // Update last updated time
                elements.lastUpdated.textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error fetching results:', error);
                showError();
            }
        }
        
        function updateClipTypeFilter() {
            const types = new Set();
            allResults.forEach(result => {
                if (result.primary_shot_type) {
                    types.add(result.primary_shot_type);
                }
            });
            
            const currentValue = elements.clipTypeFilter.value;
            elements.clipTypeFilter.innerHTML = '<option value="">All Clip Types</option>';
            
            Array.from(types).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                if (type === currentValue) {
                    option.selected = true;
                }
                elements.clipTypeFilter.appendChild(option);
            });
        }
        
        function applyFiltersAndRender() {
            filteredResults = applyFilters(allResults);
            filteredResults = applySorting(filteredResults);
            updateStatistics();
            renderTable();
        }
        
        // ===== AUTO-REFRESH =====
        
        function setupAutoRefresh() {
            clearInterval(refreshTimer);
            
            const interval = parseInt(elements.refreshInterval.value);
            if (interval === 0 || isPaused) {
                elements.refreshStatus.textContent = isPaused ? 'Paused' : 'Manual';
                return;
            }
            
            nextRefreshTime = Date.now() + (interval * 1000);
            updateRefreshCountdown();
            
            refreshTimer = setInterval(() => {
                fetchResults(false);
                nextRefreshTime = Date.now() + (interval * 1000);
            }, interval * 1000);
            
            // Update countdown every second
            setInterval(updateRefreshCountdown, 1000);
        }
        
        function updateRefreshCountdown() {
            if (isPaused || !nextRefreshTime) {
                elements.refreshStatus.textContent = isPaused ? 'Paused' : 'Manual';
                return;
            }
            
            const remaining = Math.max(0, Math.floor((nextRefreshTime - Date.now()) / 1000));
            elements.refreshStatus.textContent = `Next: ${remaining}s`;
        }
        
        // ===== EVENT LISTENERS =====
        
        // Search with debounce
        let searchDebounce = null;
        elements.searchInput.addEventListener('input', (e) => {
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(() => {
                filters.search = e.target.value.trim();
                applyFiltersAndRender();
            }, 300);
        });
        
        // Keep status filter
        elements.keepFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const filterValue = btn.dataset.filter;
                filters.keepStatus = filterValue;
                
                // Update button styles
                elements.keepFilterBtns.forEach(b => {
                    if (b === btn) {
                        b.classList.add('bg-indigo-600', 'text-white');
                        b.classList.remove('text-gray-700', 'hover:bg-gray-200');
                    } else {
                        b.classList.remove('bg-indigo-600', 'text-white');
                        b.classList.add('text-gray-700', 'hover:bg-gray-200');
                    }
                });
                
                applyFiltersAndRender();
            });
        });
        
        // Clip type filter
        elements.clipTypeFilter.addEventListener('change', (e) => {
            filters.clipType = e.target.value;
            applyFiltersAndRender();
        });
        
        // Rating filter
        elements.ratingFilter.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            filters.minRating = value;
            elements.ratingValue.textContent = value.toFixed(1);
            applyFiltersAndRender();
        });
        
        // Clear filters
        elements.clearFiltersBtn.addEventListener('click', () => {
            filters = {
                search: '',
                keepStatus: 'all',
                clipType: '',
                minRating: 0.0,
            };
            
            elements.searchInput.value = '';
            elements.clipTypeFilter.value = '';
            elements.ratingFilter.value = '0';
            elements.ratingValue.textContent = '0.0';
            
            // Reset keep filter buttons
            elements.keepFilterBtns.forEach(btn => {
                if (btn.dataset.filter === 'all') {
                    btn.classList.add('bg-indigo-600', 'text-white');
                    btn.classList.remove('text-gray-700', 'hover:bg-gray-200');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('text-gray-700', 'hover:bg-gray-200');
                }
            });
            
            applyFiltersAndRender();
        });
        
        // Sort
        elements.sortSelect.addEventListener('change', (e) => {
            const [field, direction] = e.target.value.split('-');
            sortConfig = { field, direction };
            applyFiltersAndRender();
        });
        
        // Refresh controls
        elements.refreshInterval.addEventListener('change', () => {
            setupAutoRefresh();
        });
        
        elements.pauseRefreshBtn.addEventListener('click', () => {
            isPaused = !isPaused;
            elements.pauseRefreshBtn.textContent = isPaused ? '‚ñ∂' : '‚è∏';
            elements.pauseRefreshBtn.title = isPaused ? 'Resume auto-refresh' : 'Pause auto-refresh';
            setupAutoRefresh();
        });
        
        // Table row clicks
        elements.tableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (row && row.dataset.index !== undefined) {
                const index = parseInt(row.dataset.index);
                openModal(index);
            }
        });
        
        // Transcript toggle
        elements.toggleTranscriptBtn.addEventListener('click', () => {
            const isHidden = elements.modalTranscriptContent.classList.contains('hidden');
            if (isHidden) {
                elements.modalTranscriptContent.classList.remove('hidden');
                elements.toggleTranscriptBtn.textContent = 'Hide';
            } else {
                elements.modalTranscriptContent.classList.add('hidden');
                elements.toggleTranscriptBtn.textContent = 'Show';
            }
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (elements.modal.classList.contains('flex')) {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateModal(-1);
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateModal(1);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeModal();
                }
            }
        });
        
        // ===== INITIALIZATION =====
        
        // Initial fetch
        fetchResults(true);
        
        // Setup auto-refresh
        setupAutoRefresh();
        
    </script>
</body>
</html>
